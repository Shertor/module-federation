# Создание проекта Плагинов

<i>В этом разделе рассматривается создание плагинов отдельно от основного проекта с нуля.</i>

## Настройка проекта и среды

Для работы необходимо:

* [`node.js`](https://nodejs.org/en/) версии не менее `v18.12.1`

  Вместе с node.js устанавливаются его зависимости:
  * `python` версии не менее `3.10.0`
  * `npm` не ниже `8.19.2`

* ['Angular'](https://angular.io/guide/setup-local) версии не менее `15.0.0`

* Необходим пакет [`@angular-architects/module-federation`](https://www.npmjs.com/package/@angular-architects/module-federation) версии не менее `15.0.0`
  ```bash
  npm i -g @angular-architects/module-federation
  ```

* Среда ( [`VS Code`](https://code.visualstudio.com/) )

* (опционально) [`Git`](`https://git-scm.com/`) - без него Angular при создании проекта будет выдавать ошибки (их можно игнорировать)

## Создание и настройка проекта

<i>Во всех командах предполагается, что на уровень выше создан пустой Angular проект, и уже в нем выполняются команды. Это необходимо для выполнения определенных ng команд, которые не работают без проекта.</i>

Для создания пустого Angular проекта (с названием `plugins-example`). На уровне ниже будет создан непосредственно само приложение с плагинами, так что это название влияет только на название папки и систему контроля версий:

```bash
# cmd
ng new plugins-example --create-application false --minimal
```

Далее открываем проект.
Создаем само приложение с плагинами с названием `plugins` (--style scss - опционально):

```bash
# VSCode
ng generate application plugins --routing --style scss
```

Далее его необходимо превратить в динамический модуль. Номер порта здесь необходим для режима разработки и указывается так, чтобы он был уникальный.

```bash
# VSCode
ng add @angular-architects/module-federation --project plugins --port 4201 --type remote
```

Для создания плагина необходимо содать компонент внутри модуля.

```bash
ng generate component [plugin name] --project plugins
```

Файл `[plugin name].component.ts` должен быть `standalone` компонентом. Такой компонент должен включать `CommonModule` как импорт.

```ts
// [plugin name].component.ts

import { CommonModule } from "@angular/common";
import { Component } from "@angular/core";

/**
 * Standalone компонент, подключаемый в виде плагина в основное приложение
 * Для экспорта необходимо добавить его в `webpack.config.js`
 */
@Component({
  standalone: true,
  selector: "app-[plugin name]",
  templateUrl: "./[plugin name].component.html",
  styleUrls: ["./[plugin name].component.scss"],
  imports: [CommonModule],
})
export class [plugin name] {
  constructor() {}
}
```

Созданный плагин необходимо в `AppModule` перенести в `imports`:
```ts
// app.module.ts
@NgModule({
  declarations: [AppComponent],
  imports: [BrowserModule, [plugin name]],
  providers: [],
  bootstrap: [AppComponent],
})
export class AppModule {}
```

Далее необходимо настроить `webpack.config.js`. Ниже представлен пример конфига с экспортом одного плагина. Дополнительные плагины дописываются в секцию `exposes`.

```js
`webpack.config.js`
const {
  shareAll,
  withModuleFederationPlugin,
} = require("@angular-architects/module-federation/webpack");

module.exports = withModuleFederationPlugin({
  name: "Plugins",

  exposes: {
    './[plugin name]': './projects/plugins/src/app/[plugin name]/[plugin name].component.ts'
  },

  shared: {
    ...shareAll({
      singleton: true,
      strictVersion: true,
      requiredVersion: "auto",
    }),
  },
});
```

По сути в проекте не нужен никакой дополнительный контект. Для удобства можно располагать компоненты внутри `app.component.html`. Пример созданной структуры:
```
+-- plugins/
+--   tsconfig.app.json
+--   tsconfig.spec.json
+--   webpack.config.js
+--   webpack.prod.config.js
+--   src/
+--     bootstrap.ts
+--     main.ts
+--     index.html
+--     styles.scss
+--     app/
+--       app.module.ts
+--       app.component.ts
+--       app.component.html
+--       app.component.scss
+--       [plugin name]/
+--         'здесь стандартно'
+--     assets/
```

Деплой:
```bash
ng build
```

Для коннекта плагина в основное приложение нужно прописать в манифест его параметры:

```json
  {
    "type": "module",  // Стандарт для импорта компонентов
    "remoteEntry": "http://localhost/plugins/remoteEntry.js", // Расположение плагина на сервере
    "exposedModule": "./Plugins", // Имя модуля 

    "unicDisplayName": "someName", // Уникальное имя плагина
    "componentName": "[plugin name]Component" //  Название класса плагина
  }
```

В случае, если Проект поднят в IIS, то необходимо разместить модуль с этим плагином в корневой папке по аналогии с остальными (см. раздел 4) в папку /plugins/

И обновить манифест как показано выше.

## Подключение `@shared` библиотек

Для подключение библиотек в виде синглтонов необходимо прописать импорт в `webpack.config.js` в паздел `sharedMappings`:

```js
// webpack.config.js
const {
  shareAll,
  withModuleFederationPlugin,
} = require("@angular-architects/module-federation/webpack");

module.exports = withModuleFederationPlugin({
  name: "mfePlugins",

  exposes: {
    './Plugin1': './projects/mfe-plugins/src/app/plugin1/plugin1.component.ts'
  },

  shared: {
    ...shareAll({
      singleton: true,
      strictVersion: true,
      requiredVersion: "auto",
    }),
  },
  sharedMappings: ["@shared"],
});
```
