# Создание проекта Плагинов

<i>В этом разделе рассматривается создание плагинов отдельно от основного проекта с нуля.</i>

## Настройка проекта и среды

Для работы необходимо:

- [`node.js`](https://nodejs.org/en/) версии не менее `v18.12.1`

  На этапе вопроса про зависимости поставить галочку, чтобы node сам установил все необходимые зависимости, включая `Choco`

  Вместе с node.js устанавливаются его зависимости:

  - `python` версии не менее `3.10.0`
  - `npm` не ниже `8.19.2`

- ['Angular'](https://angular.io/guide/setup-local) версии не менее `15.0.0`

- Необходим пакет [`@angular-architects/module-federation`](https://www.npmjs.com/package/@angular-architects/module-federation) версии не менее `15.0.0`

  ```bash
  npm i -g @angular-architects/module-federation
  ```

- Среда ( [`VS Code`](https://code.visualstudio.com/) )

- (опционально) [`Git`](`https://git-scm.com/`) - без него Angular при создании проекта будет выдавать ошибки (их можно игнорировать)

## Создание и настройка проекта

<i>Во всех командах предполагается, что на уровень выше создан пустой Angular проект, и уже в нем выполняются команды. Это необходимо для выполнения определенных ng команд, которые не работают без проекта.</i>

### 1. Для создания пустого Angular проекта (с названием `plugins-example`) необходимо выполнить команду:

```bash
# cmd
ng new plugins-example --create-application false --minimal
```

### 2. Далее открываем проект. Создаем само приложение с плагинами с названием `plugins` (--style scss - опционально):

__При первом запуске ANGULAR спрашивает, согласны ли мы делиться данными о использовании с Google. Рекомендуется отвечать "N"__

```bash
# VSCode
ng generate application plugins --routing --style scss
```

### 3. Далее его необходимо превратить в динамический модуль. Номер порта здесь необходим для режима разработки и указывается так, чтобы он был уникальный.

__Перед выполнением команды будет предложено установить библиотеку `@angular-architects/module-federation`, на вопрос отвечаем Да - 'Y'__

```bash
# VSCode
ng add @angular-architects/module-federation --project plugins --port 4201 --type remote
```

### 4. Для создания плагина необходимо создать компонент внутри модуля.

```bash
# VSCode
ng generate component [plugin_name] --project plugins
```

### 5. Плагин представляет собой класс, расширяющий суперкласс плагина `PluginComponent` из библиотеки `shared`.

Для его использования необходимо подключить библиотеку к проекту выполнив команду

```bash
npm i [FULL_PATH_shared-[version].tgz]
```

### 6. Файл `[plugin_name].component.ts` должен быть `standalone` компонентом расширяющим `PluginComponent`. Такой компонент должен включать `CommonModule` как импорт. Ниже представлен пример плагина, который рекомендуется для использования.

```ts
// [plugin_name].component.ts

import { CommonModule } from "@angular/common";
import { Component, OnInit } from "@angular/core";

import { PluginComponent } from 'shared';

/**
 * Standalone компонент, подключаемый в виде плагина в основное приложение
 * Для экспорта необходимо добавить его в `webpack.config.js`
 */
@Component({
  standalone: true,
  selector: "app-[plugin_name]",
  templateUrl: "./[plugin_name].component.html",
  styleUrls: ["./[plugin_name].component.scss"],
  imports: [CommonModule],
})
export class [plugin_class_name] extends PluginComponent implements OnInit {
  constructor() {
    super()
  }

  // При необходимости реализации инициализатора необходимо использовать данный метод
  childNgOnInit(): void {
    throw new Error("Method not implemented.")
  }
}
```

Созданный плагин необходимо в `AppModule` из `declarations` перенести в `imports`:

```ts
// app.module.ts
@NgModule({
  declarations: [AppComponent],
  imports: [BrowserModule, [plugin_name]],
  providers: [],
  bootstrap: [AppComponent],
})
export class AppModule {}
```

Далее необходимо настроить `webpack.config.js`. Ниже представлен пример конфига с экспортом одного плагина. Дополнительные плагины дописываются в секцию `exposes`.

```js
;`webpack.config.js`
const {
  shareAll,
  withModuleFederationPlugin,
} = require("@angular-architects/module-federation/webpack")

module.exports = withModuleFederationPlugin({
  name: "Plugins",

  exposes: {
    "./[plugin_class_name]":
      "./projects/plugins/src/app/[plugin_name]/[plugin_name].component.ts",
  },

  shared: {
    ...shareAll({
      singleton: true,
      strictVersion: true,
      requiredVersion: false,
    }),
  },
})
```

### По сути в проекте не нужен никакой дополнительный контект. Для удобства разработки можно располагать компоненты внутри `app.component.html`. Пример созданной структуры:

```
+-- plugins/
+--   tsconfig.app.json
+--   tsconfig.spec.json
+--   webpack.config.js
+--   webpack.prod.config.js
+--   src/
+--     bootstrap.ts
+--     main.ts
+--     index.html
+--     styles.scss
+--     app/
+--       app.module.ts
+--       app.component.ts
+--       app.component.html
+--       app.component.scss
+--       [plugin_name]/
+--         'здесь стандартно'
+--     assets/
```

### Проверка и запуск:

Запуск осуществляется командой

```bash
npm run run:all
```

В `app.component.html` необходимо удалить все содержимое и добавить нужный плагин.


В `package.json` в секции `devDependencies` для тестирования и разработки рекомендуется добавить следующие зависимости

```json
  "@types/jasmine": "^4.3.1",
  "jasmine-core": "^4.5.0",
  "karma": "^6.4.1",
  "karma-chrome-launcher": "^3.1.1",
  "karma-coverage": "^2.2.0",
  "karma-edgium-launcher": "^4.0.0-0",
  "karma-jasmine": "^5.1.0",
  "karma-jasmine-html-reporter": "^2.0.0",
  "ng-packagr": "^15.0.0",
  "puppeteer": "^19.4.1"
```

### Деплой и подключение:

```bash
ng build
```

Для коннекта плагина в основное приложение нужно прописать в манифест его параметры:

```json
{
  "type": "module", // Стандарт для импорта компонентов
  "remoteEntry": "http://localhost/plugins/remoteEntry.js", // Расположение плагина на сервере
  "exposedModule": "./[plugin_class_name]", // Название класса плагина

  "id": "someName", // Уникальное имя плагина
  "componentName": "[plugin_class_name]" //  Название класса плагина
}
```

В случае, если Проект поднят в IIS, то необходимо разместить модуль с этим плагином в корневой папке по аналогии с остальными (см. раздел 4) в папку /plugins/

И обновить манифест как показано выше.

