# Деплой билда в IIS

Ссылки:
https://indepth.dev/posts/1239/deploy-an-angular-application-to-iis
https://angular.io/guide/deployment
https://iis-umbraco.azurewebsites.net/downloads/microsoft/url-rewrite

## Настройка проекта

### Структура проекта

Для описания процесса деплоя проекта в IIS будет предполагаться следующая структура проекта:

```
+-- Projects/
|   +-- mfe-module/ (отдельно встраиваемый в shell модуль)
|       +--- (для информации) src/app/integrated-clock/
|   +-- mfe-plugins/ (встраиваемые в shell компоненты)
|   +-- shared/ (общая библиотека сервисов и т.п.)
|   +-- shell/
```

Проект будет располгаться на `http://localhost/` с соответствующими путями:
`http://localhost/shell`
`http://localhost/shell/mfe-module`

### `BASE HREF`

Для сборки `shell` приложения необходимо использовать команду:

```bash
ng build shell --base-href /shell/
```

Остальные модули, `mfe-module`, `mfe-plugins`, `shared` собираются аналогично

```bash
ng build [project]
```

### Настрока environment

Если ранее не были настроены environment, то удобно их создать, чтобы разделять разработку и `prod`.

```
+-- myProject/src/environments
|   +-- environment.ts
|   +-- environment.prod.ts
```

`environment.ts`

```ts
export const environment = {
  production: false,
};
```

`environment.prod.ts`

```ts
export const environment = {
  production: true,
};
```

`angular.json`

```json
"configurations": {
  "production": {
    "fileReplacements": [
      {
        "replace": "src/environments/environment.ts",
        "with": "src/environments/environment.prod.ts"
      }
    ],
    …
```

Для работы приложения в `prod` необходимо, чтобы все пути были с учетом `{ environment }`. В нашем случае это подгрузка манифестов. Внутри манифестов также должны быть указаны корректные пути с учетом размещения приложения.

## Настройка IIS

Настройка IIS будет выполнятся внутри стандартной папки `%SystemDrive%\inetpub\wwwroot`.

Структура данной папки:

```
+-- /shell/
+-- /mfe-plugins/
+-- /mfe-module/
+-- /shared/
+-- web.config
```

`web.config` создастся после того, как будет установлен [URL Rewrite Module](https://docs.microsoft.com/en-us/iis/extensions/url-rewrite-module/using-the-url-rewrite-module)

После установки модуля необходимо создать файл `web.config` внутри `/shell/src`. Файл стандартный на все ангуляр приложения.

```xml
<configuration>

<system.webServer>
  <rewrite>
    <rules>
      <rule name="Angular Routes" stopProcessing="true">
        <match url=".*" />
        <conditions logicalGrouping="MatchAll">
          <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
          <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
        </conditions>
        <action type="Rewrite" url="./index.html" />
      </rule>
    </rules>
  </rewrite>
</system.webServer>

</configuration>
```

В `angular.json` необходимо включить этот файл:

```json
"assets": [
    "assets",
    "favicon.ico",
    "web.config"
],
```

Все проекты после билда необходимо расположить в папке `%SystemDrive%\inetpub\wwwroot`

Дополнительные настройки в IIS потребоваться НЕ ДОЛЖНЫ.

- По умолчанию в IIS отключено отображение каталога папок так, что путь http://localhost/ будет выдавать ошибку Ошибка HTTP 403.14 — Forbidden. Ее можно исправить ВКЛЮЧИВ отображение каталога в Диспетчере IIS в разделе `Просмотр каталога`. Основное приложение должно работать, если дописать к пути `shell`

- Могут возникнуть проблемы с правильными путями погрузки манифестов. Путь, по которому подгружается манифест можно посмотреть в разделе Сеть в браузере.

- Иногда IIS работает со старыми файлами или настройками, или по какой-то другой неочевидной принине ничего не работает. Тогда нужно остановить IIS, перезагрузить компьютер и запустить IIS.

- Сайт рекомендуется открывать в режиме инкогнито, чтобы избежать кэширования.

- Редирект с `http://localhost` на `/shell/`:

`web.config` в корне `wwwroot`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <system.webServer>
        <directoryBrowse enabled="false" />
        <rewrite>
            <rules>
			    <rule name="Root Hit Redirect" stopProcessing="true">
					<match url="^$" />
					<action type="Rewrite" url="/shell/" />
				</rule>
            </rules>
        </rewrite>
        <httpRedirect enabled="false" destination="" httpResponseStatus="Permanent" />
    </system.webServer>
</configuration>
```
